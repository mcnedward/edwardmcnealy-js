"use strict";function ColorPicker(){var o=this;o.hours="hours",o.minutes="minutes",o.seconds="seconds",o.red="red",o.green="green",o.blue="blue",o.colors=ko.observable({red:{class:"btn-danger",interval:o.hours},green:{class:"btn-success",interval:o.minutes},blue:{class:"btn-primary",interval:o.seconds}}),o.hoursColor=ko.observable(o.colors().red.class),o.minutesColor=ko.observable(o.colors().green.class),o.secondsColor=ko.observable(o.colors().blue.class),o.update=function(e,n){o[e+"Color"](o.colors()[n].class);var t;for(var r in o.colors())if(o.colors().hasOwnProperty(r)&&o.colors()[r].interval===e){t=r;break}var i=o.colors()[n];o[i.interval+"Color"](o.colors()[t].class);var a=o.colors()[n].interval;o.colors()[n].interval=e,o.colors()[t].interval=a}}function Renderer(){function o(){if(!i.stopRendering())try{requestAnimationFrame(o),n(),e(),i.renderFunction()&&i.renderFunction()()}catch(o){}}function e(){if(r){var o=l.width/2,e=l.height/2;c.beginPath(),c.drawImage(r,o*-1,e*-1,a,s),c.closePath()}}function n(){c.clearRect(0-l.width/2,0-l.height/2,l.width,l.height)}function t(o,e){var n=parseInt(o.slice(1,3),16),t=parseInt(o.slice(3,5),16),r=parseInt(o.slice(5,7),16),i=parseInt(e,16)/255;return"rgba("+n+", "+t+", "+r+", "+i+")"}var r,i=this,a=1200,s=700,l=$("#theCanvas")[0],c=l.getContext("2d"),u=[1,0,0,1,0,0],h=!1;i.renderFunction=ko.observable(),i.stopRendering=ko.observable(!1),o(),i.loadImage=function(o){void 0===r&&(r=new Image),r.onload=function(){var o=l.width/2,e=l.height/2;h||(u[4]+=u[0]*o+u[2]*e,u[5]+=u[1]*o+u[3]*e,c.translate(o,e),h=!0),c.drawImage(r,o*-1,e*-1,a,s)},r.src=o},i.ellipse=function(o,e,n,r,i){i=t(i,100),c.beginPath(),c.ellipse(o,e,n/2,r/2,0,2*Math.PI,!1),c.fillStyle=i,c.fill()},i.polygon=function(o,e,n){var r=o.slice(0);c.beginPath(),e=t(e,n),c.fillStyle=e;for(var a=r[0],s=[],l=0;l<r.length;l++){var u=r[l];0===l?c.moveTo(u.x,u.y):(u.x===a.x&&u.y===a.y&&l<r.length-1&&(s=r.splice(l+1,r.length-l)),c.lineTo(u.x,u.y))}c.fill(),c.closePath(),s.length>0&&i.polygon(s,e)},i.text=function(o,e,n,t,r){if(c.font="bold 16px Segoe UI",c.fillStyle=t,r){var i=c.measureText(n);o-=i.width/2}c.fillText(n,o,e)},i.width=function(){return a},i.height=function(){return s};var d,v,g;i.addMouseOverEvent=function(o,e,n){d=o,v=e,g=n,l.addEventListener("mousemove",function(o){var e=l.getBoundingClientRect(),n=l.width/2,t=l.height/2,r=o.clientX-e.left-n,i=o.clientY-e.top-t;d(r,i)},!1)};var f;i.addMouseScrollEvent=function(o){f=o,l.addEventListener("mousewheel",function(){var o=event.wheelDelta/120;f(1+o/2)},!1)}}function TimeZoneService(o){function e(o,e){var r=n(l()),i=t(s()),a=n(e)-r,c=t(o)-i;return{x:a,y:c}}function n(o){o=r(o);var e=d/Math.PI*Math.pow(2,c()),n=o+Math.PI;return e*n}function t(o){o=r(o);var e=d/Math.PI*Math.pow(2,c()),n=Math.tan(Math.PI/4+o/2),t=Math.PI-Math.log(n);return e*t}function r(o){return o*(Math.PI/180)}var i,a,s,l,c,u,h=this,d=o/4;h.setup=function(o,e,n){s=o,l=e,c=n},h.loadTimeZones=function(o,n,t){function r(){fetch("/api/color-zones/map-bounds").then(function(o){o.ok&&o.json().then(function(o){for(var n=JSON.parse(o),t=0;t<n.length;t++)for(var r=n[t],a=0;a<i().length;a++)if(i()[a].matchesId(r.name)){var s=e(r.boundingBox.ymin,r.boundingBox.xmin),l=e(r.boundingBox.ymax,r.boundingBox.xmax);i()[a].boundingBox={xyMin:s,xyMax:l};break}})})}function d(o){var n=o.name.replace(/\/|_/g,"-");fetch("/api/color-zones/polygons/"+n).then(function(t){return t.ok?void t.json().then(function(n){for(var t=JSON.parse(n),r={},i=0;i<t.polygons.length;i++){for(var s=t.polygons[i],l=[],c=0;c<s.points.length;c+=2){var u=s.points.slice(c,c+2),h=e(u[0],u[1]);l.push(h)}var d=r[s.name];d?d.coords=d.coords.concat(l):(d=new Polygon(s.name,l,e(s.centroid[1],s.centroid[0])),r[s.name]=d)}var v,g=0;$.each(r,function(o,e){e.coords.length>g&&(g=e.coords.length,v=e.name)}),a()[o.name]||(a()[o.name]=[]),a()[o.name]=r,o.centroidPolygon=r[v]}):void u("Something went wrong trying to load the time zone polygons for "+n+"...")})}return u=o,void 0===s||void 0===l||void 0===c?void u("You need to call TimeZoneService.setCenterCoordinates(centerLat, centerLng, zoom) first!"):(i=n,a=t,fetch("/api/color-zones/hover-regions").then(function(o){return o.ok?void o.json().then(function(o){function n(o){for(var n=[],t=0;t<o.hoverRegion.length;t++)for(var r=o.hoverRegion[t],i=0;i<r.points.length;i+=2){var a=r.points.slice(i,i+2),s=e(a[0],a[1]);n.push(s)}return new TimeZone(o.name,n)}for(var t=JSON.parse(o),a=0;a<t.length;a++){var s=n(t[a]);d(s),i().push(s)}r()}):void u("Something went wrong trying to load the time zone regions...")}),void(h.reloadCoordinates=function(){for(var o=0;o<i().length;o++)for(var n=i()[o].coords,t=0;t<n.length;t++)n[t]=e(n[t].x,n[t].y)}))}}function TooltipService(o){function e(n){if(n!==o.length){try{o[n].id.tooltip("show")}catch(o){}setTimeout(function(){try{o[n].id.tooltip("dispose")}catch(o){}n++,o[n]||localStorage.setItem(t,!0),e(n)},1e3*o[n].timeout)}}var n=this,t="tooltipsShown";n.loadToolips=function(){var n=localStorage.getItem(t);0===o.length||n||e(0)}}function LatLng(o,e){var n=this;n.lat=o,n.lng=e}function Polygon(o,e,n){var t=this;t.name=o,t.coords=e,t.centroid=n,t.id=ko.pureComputed(function(){return t.name.replace(/\/|_/g,"-")})}function TimeZone(o,e){var n=this;n.name=o,n.coords=e,n.polygons=void 0,n.centroidPolygon=void 0,n.boundingBox=void 0,n.matchesId=function(o){return n.id()===o.replace(/\/|_/g,"-")},n.id=ko.pureComputed(function(){return n.name.replace(/\/|_/g,"-")})}var ColorZonesViewModel=function(o,e,n){function t(e){b=e,fetch("/api/color-zones/map?centerLat="+d.centerLat()+"&centerLng="+d.centerLng()+"&zoom="+d.zoom()+"&width="+v+"&height="+g).then(function(e){return e.ok?void e.text().then(function(e){o.loadImage(e),void 0!==b&&b()}):void console.error("Something went wrong trying to load the map image...")})}function r(o){return o<10&&(o="0"+o),o.toString()}function i(o,e,t,r){var i=n.colors()[o].interval;switch(i){case n.hours:return e;case n.minutes:return t;case n.seconds:return r;default:console.warn("Could not find an interval for: "+i+"...")}}function a(o,e,n,t){for(var r=0,i=o[o.length-1],a=0;a<o.length;a++){var s=o[a];if(i.y<=n&&s.y>=n||i.y>n&&s.y<n){var l=(s.x-i.x)/(s.y-i.y),c=l*(n-i.y)+i.x;c<e&&r++}i=s}return r%2===1}var s,l,c,u,h,d=this,v=o.width(),g=o.height(),f="#660d60",m="HH:mm:ss";d.colorPicker=ko.observable(n),d.opacity=ko.observable(80),d.showTimes=ko.observable(!1),d.colorAllZones=ko.observable(!0),d.width=ko.observable(v+"px"),d.height=ko.observable(g+"px"),d.zoom=ko.observable(1),d.centerLat=ko.observable(20),d.centerLng=ko.observable(0),d.timeZones=ko.observableArray(),d.timeZoneRegions=ko.observable({});var p=ko.pureComputed(function(){return d.colorAllZones()?"white":"black"});o.renderFunction(function(){if(0!==d.timeZones().length){for(var e=[],t=0;t<d.timeZones().length;t++){var a=d.timeZones()[t],v=moment().tz(a.name),g=r(v.hours()),b=r(v.minutes()),y=r(v.seconds()),x=i(n.red,g,b,y),w=i(n.green,g,b,y),k=i(n.blue,g,b,y),P="#"+x+w+k;if(d.colorAllZones()&&o.polygon(a.coords,P,d.opacity()),void 0!==a.centroidPolygon){var Z={textX:a.centroidPolygon.centroid.x,textY:a.centroidPolygon.centroid.y,time:v.format(m),colorHex:P};e.push(Z),s&&""!==s&&s===a.name&&(c=Z)}}var M=d.timeZoneRegions()[s];if(M&&($.each(M,function(e,n){if(n&&n.coords&&0!==n.coords.length){var t=d.colorAllZones()?f:c.colorHex;o.polygon(n.coords,t,80)}}),d.showTimes()||o.text(u,h-5,c.time,p(),!0),o.text(u,h-25,l,p(),!0),o.text(u,h-45,c.colorHex,p(),!0)),d.showTimes())for(var I=0;I<e.length;I++)o.text(e[I].textX,e[I].textY,e[I].time,p())}});var b;t(),e.setup(d.centerLat,d.centerLng,d.zoom),e.loadTimeZones(function(o){console.error(o)},d.timeZones,d.timeZoneRegions),o.addMouseOverEvent(function(o,e){if(0!==d.timeZones().length)for(var n=0;n<d.timeZones().length;n++){var t=d.timeZones()[n],r=t.boundingBox;if(void 0===r)return;if(e>r.xyMax.y&&e<r.xyMin.y&&o>r.xyMin.x&&o<r.xyMax.x){var i=d.timeZoneRegions()[t.name];for(var c in i)if(i.hasOwnProperty(c)&&a(i[c].coords,o,e))return s=t.name,l=c,u=o,void(h=e)}}},d.centerLat(),d.centerLng()),o.addMouseScrollEvent(function(o){if(o>1?d.zoom(d.zoom()+1):d.zoom(d.zoom()-1),d.zoom()<1)return void d.zoom(1)})};